---
# Task File for patch-cloud-linux-os prereqs

#Pulls the latest subscription data from the Satellite server
- name: Refresh the subscription manager
  command: subscription-manager refresh

#Updates the system information
- name: Refresh the subscription manager
  command: subscription-manager facts --update

#Yum Clean All
- name: Print debug statement
  debug:
    msg: "Disk space before clean up"

- name: "Disk space of /var/cache/yum - Before clean up"
  command: df -hP /var/cache/yum

- name: Print debug statement
  debug: 
    msg: "Start of Yum Clean All"
    

- name: Clean the yum Cache
  shell: |
    yum clean all 1>/dev/null 2>&1
    rm -rf /var/cache/yum/* 1>/dev/null 2>&1
  register: shell_output

# - name: Clean the yum cache
#   yum:
#     name: '*'
#     state: absent
  
# - name: Remove the files in /var/yum/cache
#   command: rm -rf /var/cache/yum/* 1>/dev/null 2>&1
#   register: result
  
- name: Print debug statement
  debug:
    msg: "Disk space before clean up"

- name: Disk space of /var/cache/yum - After clean up
  command: df -hP /var/cache/yum

#Yum make cache

- name: Print debug statement
  debug:
    msg: "YUM CACHE - STARTED"

- name: Display enabled software repositories
  command: yum repolist >/dev/null 2>&1
  register: yum_makecache_rc

- name: Print debug statement
  debug: 
    msg: "/var/cache/yum FS size - after yum makecache"

- name: "Yum cache FS size - after yum makecahe"
  command: df -hP /var/cache/yum

- name: "Yum cache size - after yum makecahe"
  command: du -sm /var/cache/yum
  
- name: Print debug statement
  debug:
    msg: "Yum makecache completed"    

#Clean-up of non-Satellite repo files- All files not ending with redhat.repo are renamed mv ${fn} ${fn}.ENPM_bk_${TS}

- name: Print debug statement
  debug:
    msg: "Cleanup of non-Satellite repo files - STARTED"

- name: List all files not ending with redhat.repo and rename them to {filename}.ENPM_bk_${TS}
  shell: |
    /bin/ls -1tr /etc/yum.repos.d/*.repo | egrep -v "\/etc\/yum\.repos\.d\/redhat\.repo$" |
    while read fn; do
    displaymsg "msg" "renaming non-Satellite repo file ${fn} to ${fn}.ENPM_bk_${TS}"
    mv ${fn} ${fn}.ENPM_bk_${TS}
    done
- name: Print debug statement
  debug: 
    msg: "Cleanup of non-Satellite repo files - COMPLETED"

...
